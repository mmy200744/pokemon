<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- favicon -->
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="./favicon/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="./favicon/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="./favicon/android-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="./favicon/android-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="./favicon/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="./favicon/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="./favicon/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="./favicon/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./favicon/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="./favicon/apple-icon-57x57.png"
    />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />

    <meta property="og:title" content="잡아라! 포켓몬!" />

    <meta property="og:description" content="삐까삐까" />
    property="og:image"
    content="https://mmy200744.github.io/pokemon/pikachu.jpg" />
    <meta property="og:image:width" content="600" />
    <meta property="og:image:height" content="400" />
    <title>포켓몬 도감</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen font-sans p-4 sm:p-8">
    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
      <main class="md:col-span-2 bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
          포켓몬 도감
        </h1>
        <div class="flex mb-6">
          <input
            id="pokeId"
            type="number"
            min="1"
            placeholder="포켓몬 ID를 입력하세요"
            class="border rounded-l-lg p-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          />
          <button
            id="pokeBtn"
            class="bg-blue-500 text-white p-3 rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition font-semibold"
          >
            검색
          </button>
        </div>
        <section id="pokeBox">
          <div class="text-center text-gray-500 pt-10">
            포켓몬을 검색해주세요.
          </div>
        </section>
      </main>
      <aside class="bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-1600">
          검색 기록
        </h1>
        <ul id="historyBox" class="space-y-2"></ul>
      </aside>
    </div>
    <script>
      // 1. API에서 데이터 호출하기
      async function getPokemon(id) {
        if (!id) {
          alert("포켓몬 ID를 입력해주세요.");
          return;
        }
        // 로딩 UI 표시
        const pokeBox = document.querySelector("#pokeBox");
        pokeBox.innerHTML = `<div class="text-center text-gray-500 pt-10">로딩중...</div>`;

        try {
          console.log(`${id}번 포켓몬을 불러옵니다`);
          const response = await fetch(
            `https://pokeapi.co/api/v2/pokemon/${id}`
          );
          const data = await response.json();
          console.log(data);

          // 타입(Type) 및 특성(Ability) 한글 이름 가져오기
          const typePromises = data.types.map(async (typeInfo) => {
            const typeRes = await fetch(typeInfo.type.url);
            const typeData = await typeRes.json();
            const koName =
              typeData.names.find((name) => name.language.name === "ko")
                ?.name || typeInfo.type.name;
            return { name: koName, engName: typeInfo.type.name };
          });

          const abilityPromises = data.abilities.map(async (abilityInfo) => {
            const abilityRes = await fetch(abilityInfo.ability.url);
            const abilityData = await abilityRes.json();
            const koName =
              abilityData.names.find((name) => name.language.name === "ko")
                ?.name || abilityInfo.ability.name;
            return { name: koName };
          });

          const [types, abilities] = await Promise.all([
            Promise.all(typePromises),
            Promise.all(abilityPromises),
          ]);

          // 3. 포획 장소 데이터 가져오기
          const response3 = await fetch(data.location_area_encounters);
          const locationsData = await response3.json();

          // 4. 장소와 버전별로 데이터 그룹화
          const locationVersionMap = new Map();
          const locationPromises = locationsData.map(async (encounter) => {
            const locResponse = await fetch(encounter.location_area.url);
            const locData = await locResponse.json();
            const koLocation = locData.names.find(
              (name) => name.language.name === "ko"
            );
            const locationName =
              koLocation?.name || encounter.location_area.name;

            const versionNames = encounter.version_details.map(
              (detail) => detail.version.name
            );

            if (!locationVersionMap.has(locationName)) {
              locationVersionMap.set(locationName, new Set());
            }
            versionNames.forEach((v) =>
              locationVersionMap.get(locationName).add(v)
            );
          });
          await Promise.all(locationPromises);

          const locations = Array.from(
            locationVersionMap,
            ([name, versions]) => ({ name, versions: Array.from(versions) })
          ).slice(0, 5);
          // 이름 (영어)
          console.log(data.name);
          // 앞모습
          console.log(data.sprites.front_default);
          // 울음소리
          console.log(data.cries.latest);

          const response2 = await fetch(
            `https://pokeapi.co/api/v2/pokemon-species/${id}`
          );
          const data2 = await response2.json();
          // 한글 이름
          console.log(data2);
          console.log(data2.names); // 스페이스도 없고 특수문자도 없어서..
          console.log(data2.names.filter((v) => v.language.name === "ko"));
          console.log(
            data2.names.filter((v) => v.language.name === "ko")[0].name
          );
          const koName = data2.names.filter((v) => v.language.name === "ko")[0]
            .name;
          // 변수를 바로 넣으면 해당 변수 이름이 key로 인식되어서 바로 들어가게 됨

          const poke = {
            engName: data.name,
            koName,
            shape: data.sprites.front_default,
            sound: data.cries.latest,
            locations,
            types,
            abilities,
          };
          localStorage.setItem("recent", JSON.stringify(poke)); // 문자열화
          updateHistory(poke);
          renderPoke(poke);
        } catch (error) {
          console.error("포켓몬 데이터를 가져오는 데 실패했습니다:", error);
          pokeBox.innerHTML = `<div class="text-center text-red-500 pt-10">포켓몬 정보를 찾을 수 없습니다. (ID: ${id})</div>`;
        }
      }
      //   getPokemon(1);
      // 2. input 통해 번호 바꿔보기
      const pokeBtn = document.querySelector("#pokeBtn");
      const pokeId = document.querySelector("#pokeId");
      pokeBtn.addEventListener("click", () => getPokemon(pokeId.value));
      pokeId.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          getPokemon(pokeId.value);
        }
      });
      // 3. 데이터 화면에 그리기
      function renderPoke({
        engName,
        koName,
        shape,
        sound,
        locations,
        types,
        abilities,
      }) {
        const pokeBox = document.querySelector("#pokeBox");

        const typeColorMap = {
          normal: "bg-gray-400 text-white",
          fire: "bg-red-500 text-white",
          water: "bg-blue-500 text-white",
          grass: "bg-green-500 text-white",
          electric: "bg-yellow-400 text-gray-800",
          ice: "bg-blue-200 text-gray-800",
          fighting: "bg-red-700 text-white",
          poison: "bg-purple-500 text-white",
          ground: "bg-yellow-600 text-white",
          flying: "bg-indigo-400 text-white",
          psychic: "bg-pink-500 text-white",
          bug: "bg-lime-500 text-white",
          rock: "bg-yellow-700 text-white",
          ghost: "bg-indigo-700 text-white",
          dragon: "bg-indigo-800 text-white",
          dark: "bg-gray-800 text-white",
          steel: "bg-gray-500 text-white",
          fairy: "bg-pink-300 text-gray-800",
        };

        const typesHTML = types
          .map(
            (type) =>
              `<span class="text-sm font-medium me-2 px-2.5 py-0.5 rounded ${
                typeColorMap[type.engName] || "bg-gray-200"
              }">${type.name}</span>`
          )
          .join("");

        const locationsHTML =
          locations && locations.length > 0
            ? `<div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-gray-500">
                  <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                      <tr>
                          <th scope="col" class="px-4 py-3">서식지</th>
                          <th scope="col" class="px-4 py-3">등장 버전</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${locations
                        .map(
                          (loc) => `
                          <tr class="border-b">
                              <th scope="row" class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${
                                loc.name
                              }</th>
                              <td class="px-4 py-3 flex flex-wrap gap-1">${loc.versions
                                .map(
                                  (v) =>
                                    `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded">${v}</span>`
                                )
                                .join("")}</td>
                          </tr>
                      `
                        )
                        .join("")}
                  </tbody>
              </table>
            </div>`
            : '<p class="text-gray-500 text-sm">알려진 서식지 정보 없음</p>';

        const abilitiesHTML = abilities
          .map((ability) => `<li class="text-gray-600">${ability.name}</li>`)
          .join("");

        pokeBox.innerHTML = `
          <div class="border rounded-lg p-6 text-center bg-gray-50 animate-pulse-once">
              <img src="${shape}" alt="${koName}" class="mx-auto h-40 w-40 mb-4 drop-shadow-lg">
              <h4 class="text-2xl font-bold text-gray-800">${koName}</h4>
              <h5 class="text-lg text-gray-500 mb-4 capitalize">${engName}</h5>
              <div class="flex justify-center gap-2 mb-4">${typesHTML}</div>
              <audio src="${sound}" controls class="w-full mt-4"></audio>
              <div class="mt-6 pt-4 border-t">
                  <h6 class="font-bold text-md text-gray-700 mb-3">주요 서식지</h6>
                  ${locationsHTML}
              </div>
              <div class="mt-6 pt-4 border-t">
                  <h6 class="font-bold text-md text-gray-700 mb-3">특성</h6>
                  <ul class="text-center">
                    ${abilitiesHTML}
                  </ul>
              </div>
          </div>
          `;
      }

      // 4. 검색 기록 업데이트 및 렌더링
      function updateHistory(newPoke) {
        const rawHistory = localStorage.getItem("pokeHistory");
        let history = rawHistory ? JSON.parse(rawHistory) : [];

        // 중복 제거: 같은 ID의 포켓몬이 있다면 기존 기록에서 제거
        history = history.filter((p) => p.engName !== newPoke.engName);

        // 새로운 기록을 맨 앞에 추가
        history.unshift(newPoke);

        // 기록은 최대 10개까지만 저장
        if (history.length > 10) {
          history = history.slice(0, 10);
        }

        localStorage.setItem("pokeHistory", JSON.stringify(history));
        renderHistory();
      }

      function renderHistory() {
        const historyBox = document.querySelector("#historyBox");
        const rawHistory = localStorage.getItem("pokeHistory");
        const history = rawHistory ? JSON.parse(rawHistory) : [];

        historyBox.innerHTML = history
          .map(
            (poke) => `
              <li class="p-2 rounded-md hover:bg-gray-200 cursor-pointer flex items-center gap-4" onclick='renderPoke(${JSON.stringify(
                poke
              )})'>
                <img src="${
                  poke.shape
                }" class="w-8 h-8 bg-gray-100 rounded-full" alt="${
              poke.koName
            }" />
                <span class="font-medium text-gray-1000">${poke.koName}</span>
              </li>`
          )
          .join("");
      }

      // 5. 페이지 로드 시 기록 불러오기
      document.addEventListener("DOMContentLoaded", () => {
        renderHistory();
        const history = JSON.parse(localStorage.getItem("pokeHistory") || "[]");
        if (history.length > 0) {
          renderPoke(history[0]);
        }
      });
    </script>
  </body>
</html>
